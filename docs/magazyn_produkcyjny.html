<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikacja Magazynu Produkcyjnego</title>
    <!-- Ładowanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 0.75rem;
        }
        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tr:hover {
            background-color: #eef2ff;
        }
        th:first-child { border-top-left-radius: 0.75rem; }
        th:last-child { border-top-right-radius: 0.75rem; }
        tr:last-child td:first-child { border-bottom-left-radius: 0.75rem; }
        tr:last-child td:last-child { border-bottom-right-radius: 0.75rem; }

        /* Kontener na etykiety do druku (domyślnie poza ekranem) */
        .print-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 100%;
            height: auto;
            overflow: hidden;
            z-index: -1;
        }

        /* Styl dla wydruku etykiet */
        @media print {
            body > *:not(.print-container) {
                display: none;
            }
            .print-container {
                position: static;
                left: auto;
                top: auto;
                display: block;
                width: 100%;
                margin: 0;
                padding: 0;
                z-index: auto;
            }
            .label-item {
                display: inline-block;
                width: 9cm;
                height: 5cm;
                border: 1px solid #333;
                margin: 0.5cm;
                padding: 0.5cm;
                box-sizing: border-box;
                text-align: center;
                page-break-inside: avoid;
                overflow: hidden;
            }
            .label-item .qr-code {
                width: 3.5cm !important;
                height: 3.5cm !important;
                margin: 0 auto;
                display: block;
            }
            .label-item h3 {
                font-size: 14px;
                font-weight: bold;
                margin: 5px 0;
            }
            .label-item p {
                font-size: 12px;
                margin: 2px 0;
            }
        }

        /* Style dla modalu skanera */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            margin: 0 auto;
            overflow: hidden;
            position: relative;
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .inventory-update {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="p-8">
    <div class="container mx-auto bg-white shadow-lg rounded-xl overflow-hidden mb-8">
        <h1 class="text-3xl font-bold text-center py-6 bg-indigo-600 text-white rounded-t-xl">
            Aplikacja Magazynu Produkcyjnego
        </h1>
        <div class="p-6">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Dodaj Nowy Element</h2>
            <form id="addItemForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50">
                <div>
                    <label for="itemId" class="block text-sm font-medium text-gray-700">ID Elementu:</label>
                    <input type="text" id="itemId" name="itemId" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="itemName" class="block text-sm font-medium text-gray-700">Nazwa Elementu:</label>
                    <input type="text" id="itemName" name="itemName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Opis:</label>
                    <input type="text" id="description" name="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Kategoria:</label>
                    <input type="text" id="category" name="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Ilość:</label>
                    <input type="number" id="quantity" name="quantity" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="unit" class="block text-sm font-medium text-gray-700">Jednostka:</label>
                    <input type="text" id="unit" name="unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">Lokalizacja:</label>
                    <input type="text" id="location" name="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="supplier" class="block text-sm font-medium text-gray-700">Dostawca:</label>
                    <input type="text" id="supplier" name="supplier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="reorderLevel" class="block text-sm font-medium text-gray-700">Poziom Zamówienia:</label>
                    <input type="number" id="reorderLevel" name="reorderLevel" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Dodaj Element
                    </button>
                </div>
            </form>

            <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Lista Elementów</h2>
            <div class="flex mb-4 space-x-2">
                <button id="printLabelsBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Drukuj Etykiety
                </button>
                <button id="scanQrBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Skanuj Kod QR
                </button>
            </div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            ID Elementu
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Nazwa Elementu
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Ilość
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Lokalizacja
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Akcje
                        </th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Elementy będą dodawane tutaj przez JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Kontener na etykiety do druku (domyślnie poza ekranem) -->
    <div id="printContainer" class="print-container"></div>

    <!-- Modal do skanowania QR kodów -->
    <div id="scannerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Skanowanie Kodu QR</h2>
            <div id="scanner-container">
                <video id="scanner-video"></video>
            </div>
            <div id="scan-result" class="inventory-update hidden">
                <h3 id="scanned-item-name" class="font-bold mb-2">Nazwa przedmiotu</h3>
                <p id="scanned-item-id"></p>
                <p id="scanned-item-quantity" class="mb-3">Aktualna ilość: <span></span></p>
                
                <div class="flex flex-col space-y-3">
                    <div class="flex items-center">
                        <input type="number" id="quantity-change" class="w-20 p-2 border rounded mr-2" min="1" value="1">
                        <button id="add-quantity" class="bg-green-500 text-white px-3 py-1 rounded mr-2">Dodaj</button>
                        <button id="subtract-quantity" class="bg-red-500 text-white px-3 py-1 rounded">Odejmij</button>
                    </div>
                    <button id="update-inventory" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Aktualizuj stan magazynowy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ładowanie bibliotek -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        const addItemForm = document.getElementById('addItemForm');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const printLabelsBtn = document.getElementById('printLabelsBtn');
        const printContainer = document.getElementById('printContainer');
        const scanQrBtn = document.getElementById('scanQrBtn');
        const scannerModal = document.getElementById('scannerModal');
        const closeModal = document.querySelector('.close');
        const scanResult = document.getElementById('scan-result');
        const scannedItemName = document.getElementById('scanned-item-name');
        const scannedItemId = document.getElementById('scanned-item-id');
        const scannedItemQuantity = document.getElementById('scanned-item-quantity').querySelector('span');
        const quantityChange = document.getElementById('quantity-change');
        const addQuantityBtn = document.getElementById('add-quantity');
        const subtractQuantityBtn = document.getElementById('subtract-quantity');
        const updateInventoryBtn = document.getElementById('update-inventory');

        // Adres URL Twojego serwera Express
        const API_URL = 'https://serwer.sebaruman.pl/api/inventory';

        let inventory = []; // Tablica do przechowywania elementów magazynowych
        let scannedItem = null; // Aktualnie zeskanowany element
        let quantityOperation = 'add'; // Domyślna operacja: 'add' lub 'subtract'
        let html5QrCode = null; // Referencja do skanera QR

        // Funkcja do pobierania danych z serwera
        async function fetchInventory() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Błąd HTTP! Status: ${response.status}`);
                }
                inventory = await response.json();
                renderInventory(); // Odśwież tabelę po pobraniu danych
            } catch (error) {
                console.error('Błąd podczas pobierania danych z serwera:', error);
                alert('Nie udało się pobrać danych magazynowych. Upewnij się, że serwer działa.');
            }
        }

        // Funkcja do renderowania (wyświetlania) elementów w tabeli
        function renderInventory() {
            inventoryTableBody.innerHTML = ''; // Wyczyść tabelę przed ponownym renderowaniem
            inventory.forEach((item, index) => {
                const row = inventoryTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.itemId}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.itemName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.quantity} ${item.unit || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.location || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="printSingleLabel('${item.itemId}')" class="text-green-600 hover:text-green-900">Drukuj</button>
                        <button onclick="showItemDetails('${item.itemId}')" class="text-blue-600 hover:text-blue-900 ml-2">Info</button>
                        <button onclick="deleteItem('${item.itemId}')" class="text-red-600 hover:text-red-900 ml-2">Usuń</button>
                    </td>
                `;
            });
        }

        // Funkcja diagnostyczna - pokaż szczegóły elementu
        function showItemDetails(itemId) {
            const item = inventory.find(i => i.itemId === itemId);
            if (!item) {
                alert('Nie znaleziono elementu!');
                return;
            }
            
            console.log('Szczegóły elementu:', item);
            
            // Utwórz czytelny tekst ze wszystkimi właściwościami
            let details = 'Szczegóły elementu:\n\n';
            for (const [key, value] of Object.entries(item)) {
                details += `${key}: ${value}\n`;
            }
            
            alert(details);
        }

        // Funkcja do dodawania nowego elementu
        addItemForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Zapobiegaj domyślnej wysyłce formularza

            const newItem = {
                itemId: document.getElementById('itemId').value,
                itemName: document.getElementById('itemName').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                quantity: parseInt(document.getElementById('quantity').value),
                unit: document.getElementById('unit').value,
                location: document.getElementById('location').value,
                supplier: document.getElementById('supplier').value,
                reorderLevel: parseInt(document.getElementById('reorderLevel').value),
                lastUpdated: new Date().toISOString().slice(0, 10) // Aktualna data w formacie YYYY-MM-DD
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newItem)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Błąd HTTP! Status: ${response.status}, Wiadomość: ${errorData.message}`);
                }

                await fetchInventory(); // Odśwież dane po dodaniu
                addItemForm.reset(); // Wyczyść formularz
                alert('Element dodany pomyślnie!');
            } catch (error) {
                console.error('Błąd podczas dodawania elementu:', error);
                alert(`Nie udało się dodać elementu: ${error.message}`);
            }
        });

        // Funkcja do usuwania elementu
        async function deleteItem(itemId) {
            if (confirm(`Czy na pewno chcesz usunąć element o ID: ${itemId}?`)) {
                try {
                    const response = await fetch(`${API_URL}/${itemId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Błąd HTTP! Status: ${response.status}, Wiadomość: ${errorData.message}`);
                    }

                    await fetchInventory(); // Odśwież dane po usunięciu
                    alert(`Element ${itemId} usunięty pomyślnie!`);
                } catch (error) {
                    console.error('Błąd podczas usuwania elementu:', error);
                    alert(`Nie udało się usunąć elementu: ${error.message}`);
                }
            }
        }

        // Funkcja do aktualizacji ilości produktu metodą "usuń i dodaj"
        async function updateQuantity(itemId, newQuantity) {
            try {
                // Znajdź aktualne dane produktu
                const item = inventory.find(item => item.itemId === itemId);
                if (!item) {
                    throw new Error('Nie znaleziono produktu o podanym ID');
                }
                
                console.log('Aktualizacja produktu:', itemId, 'Nowa ilość:', newQuantity);
                
                // Tworzymy kopię obiektu z nową ilością
                const updatedItem = {
                    ...item,
                    quantity: newQuantity,
                    lastUpdated: new Date().toISOString().slice(0, 10)
                };
                
                // Usuwanie nie może zawierać _id, więc usuwamy używając itemId
                console.log('Krok 1: Usuwanie istniejącego elementu');
                const deleteResponse = await fetch(`${API_URL}/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!deleteResponse.ok) {
                    console.error('Błąd podczas usuwania:', await deleteResponse.text());
                    throw new Error(`Nie można usunąć elementu. Status: ${deleteResponse.status}`);
                }
                
                console.log('Krok 2: Dodawanie zaktualizowanego elementu');
                // Usuwamy pole _id przed dodaniem - MongoDB wygeneruje nowe
                delete updatedItem._id;
                
                const addResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedItem)
                });
                
                if (!addResponse.ok) {
                    console.error('Błąd podczas dodawania:', await addResponse.text());
                    throw new Error(`Nie można dodać zaktualizowanego elementu. Status: ${addResponse.status}`);
                }
                
                console.log('Aktualizacja zakończona sukcesem!');
                await fetchInventory(); // Odśwież dane po aktualizacji
                return true;
            } catch (error) {
                console.error('Błąd podczas aktualizacji ilości:', error);
                alert(`Nie udało się zaktualizować ilości: ${error.message}`);
                return false;
            }
        }

        // Funkcja do generowania pojedynczej etykiety
        function printSingleLabel(itemId) {
            const item = inventory.find(i => i.itemId === itemId);
            if (!item) {
                alert('Nie znaleziono elementu o podanym ID!');
                return;
            }
            
            printContainer.innerHTML = ''; // Wyczyść kontener
            
            const labelDiv = document.createElement('div');
            labelDiv.classList.add('label-item');
            
            // Kontener na kod QR
            const qrCodeDiv = document.createElement('div');
            qrCodeDiv.classList.add('qr-code');
            labelDiv.appendChild(qrCodeDiv);
            
            // Dodaj informacje tekstowe
            const itemNameElem = document.createElement('h3');
            itemNameElem.textContent = item.itemName;
            labelDiv.appendChild(itemNameElem);
            
            const itemIdElem = document.createElement('p');
            itemIdElem.textContent = `ID: ${item.itemId}`;
            labelDiv.appendChild(itemIdElem);
            
            const quantityElem = document.createElement('p');
            quantityElem.textContent = `Ilość: ${item.quantity} ${item.unit || ''}`;
            labelDiv.appendChild(quantityElem);
            
            const locationElem = document.createElement('p');
            locationElem.textContent = `Lokalizacja: ${item.location || ''}`;
            labelDiv.appendChild(locationElem);
            
            printContainer.appendChild(labelDiv);
            
            // Generuj kod QR bezpośrednio w kontenerze
            new QRCode(qrCodeDiv, {
                text: item.itemId,
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Daj przeglądarce czas na wyrenderowanie kodu QR przed drukowaniem
            setTimeout(() => {
                window.print();
            }, 200);
        }

        // Funkcja do generowania i drukowania wszystkich etykiet
        printLabelsBtn.addEventListener('click', function() {
            printContainer.innerHTML = ''; // Wyczyść kontener przed nowym drukiem

            if (inventory.length === 0) {
                alert('Brak elementów do wydrukowania etykiet.');
                return;
            }

            // Generuj etykiety dla każdego elementu
            inventory.forEach(item => {
                const labelDiv = document.createElement('div');
                labelDiv.classList.add('label-item');
                
                // Kontener na kod QR
                const qrCodeDiv = document.createElement('div');
                qrCodeDiv.classList.add('qr-code');
                labelDiv.appendChild(qrCodeDiv);
                
                // Dodaj informacje tekstowe
                const itemNameElem = document.createElement('h3');
                itemNameElem.textContent = item.itemName;
                labelDiv.appendChild(itemNameElem);
                
                const itemIdElem = document.createElement('p');
                itemIdElem.textContent = `ID: ${item.itemId}`;
                labelDiv.appendChild(itemIdElem);
                
                const quantityElem = document.createElement('p');
                quantityElem.textContent = `Ilość: ${item.quantity} ${item.unit || ''}`;
                labelDiv.appendChild(quantityElem);
                
                const locationElem = document.createElement('p');
                locationElem.textContent = `Lokalizacja: ${item.location || ''}`;
                labelDiv.appendChild(locationElem);
                
                printContainer.appendChild(labelDiv);
                
                // Generuj kod QR bezpośrednio w kontenerze
                new QRCode(qrCodeDiv, {
                    text: item.itemId,
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            });
            
            // Daj przeglądarce czas na wyrenderowanie wszystkich kodów QR przed drukowaniem
            setTimeout(() => {
                window.print();
            }, 500);
        });

        // Inicjalizacja skanera QR
        function initQrScanner() {
            if (html5QrCode) {
                return; // Skaner już zainicjalizowany
            }
            
            html5QrCode = new Html5Qrcode("scanner-container");
            
            const config = { 
                fps: 10, 
                qrbox: 250 
            };
            
            // Obsługa skanowania
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
        }
        
        // Zatrzymanie skanera
        function stopQrScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log('Skaner zatrzymany');
                    html5QrCode = null; // Ważne: resetuj zmienną, aby umożliwić ponowną inicjalizację
                }).catch(err => {
                    console.error('Błąd podczas zatrzymywania skanera:', err);
                    html5QrCode = null; // Resetuj nawet w przypadku błędu
                });
            } else {
                html5QrCode = null; // Na wszelki wypadek
            }
        }

        // Funkcja wywoływana po pomyślnym zeskanowaniu kodu QR
        function onScanSuccess(decodedText) {
            // Szukamy produktu o ID równym zeskanowanemu kodowi
            const item = inventory.find(item => item.itemId === decodedText);
            
            if (item) {
                // Zatrzymaj skaner po znalezieniu produktu
                stopQrScanner();
                
                // Zapisz zeskanowany element
                scannedItem = item;
                
                // Wyświetl informacje o produkcie
                scannedItemName.textContent = item.itemName;
                scannedItemId.textContent = `ID: ${item.itemId}`;
                scannedItemQuantity.textContent = `${item.quantity} ${item.unit || ''}`;
                
                // Pokaż panel aktualizacji
                scanResult.classList.remove('hidden');
            } else {
                alert(`Nie znaleziono produktu o ID: ${decodedText}`);
            }
        }
        
        // Funkcja wywoływana w przypadku błędu skanowania
        function onScanFailure(error) {
            // Błędy skanowania są częste (np. gdy nie ma kodu QR w widoku), więc nie wyświetlamy alertu
            console.log('Skanowanie w toku...');
        }

        // Obsługa przycisku "Skanuj Kod QR"
        scanQrBtn.addEventListener('click', function() {
            // Upewnij się, że skaner jest zresetowany
            html5QrCode = null;
            
            // Pokaż modal skanera
            scannerModal.style.display = 'block';
            
            // Zresetuj panel wyników
            scanResult.classList.add('hidden');
            
            // Inicjalizuj skaner
            setTimeout(() => {
                initQrScanner();
            }, 100); // Małe opóźnienie dla lepszej kompatybilności z przeglądarkami
        });
        
        // Zamknięcie modalu
        closeModal.addEventListener('click', function() {
            scannerModal.style.display = 'none';
            stopQrScanner();
        });
        
        // Zamknięcie modalu po kliknięciu poza obszarem modalu
        window.addEventListener('click', function(event) {
            if (event.target === scannerModal) {
                scannerModal.style.display = 'none';
                stopQrScanner();
            }
        });
        
        // Przyciski dodawania/odejmowania ilości
        addQuantityBtn.addEventListener('click', function() {
            quantityOperation = 'add';
            addQuantityBtn.classList.add('bg-green-700');
            addQuantityBtn.classList.remove('bg-green-500');
            subtractQuantityBtn.classList.add('bg-red-500');
            subtractQuantityBtn.classList.remove('bg-red-700');
        });
        
        subtractQuantityBtn.addEventListener('click', function() {
            quantityOperation = 'subtract';
            subtractQuantityBtn.classList.add('bg-red-700');
            subtractQuantityBtn.classList.remove('bg-red-500');
            addQuantityBtn.classList.add('bg-green-500');
            addQuantityBtn.classList.remove('bg-green-700');
        });
        
        // Przycisk aktualizacji stanu magazynowego
        updateInventoryBtn.addEventListener('click', async function() {
            if (!scannedItem) {
                alert('Nie wybrano produktu!');
                return;
            }
            
            const changeValue = parseInt(quantityChange.value);
            if (isNaN(changeValue) || changeValue <= 0) {
                alert('Wprowadź poprawną liczbę sztuk!');
                return;
            }
            
            let newQuantity;
            if (quantityOperation === 'add') {
                newQuantity = scannedItem.quantity + changeValue;
            } else {
                newQuantity = Math.max(0, scannedItem.quantity - changeValue);
            }
            
            const success = await updateQuantity(scannedItem.itemId, newQuantity);
            if (success) {
                alert(`Stan magazynowy produktu "${scannedItem.itemName}" został zaktualizowany.`);
                scannerModal.style.display = 'none';
                stopQrScanner();
            }
        });

        // Inicjalizacja: pobierz dane z serwera przy starcie aplikacji
        fetchInventory();
    </script>
</body>
</html>
