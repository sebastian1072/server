<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikacja Magazynu Produkcyjnego</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Zmiana: Lżejsze tło */
            color: #343a40;
        }
        .container-app {
            max-width: 1200px; /* Zmiana: Ograniczenie szerokości na dużych ekranach */
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 0;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card-header-custom {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
            border-top-left-radius: 0.75rem !important;
            border-top-right-radius: 0.75rem !important;
        }
        .form-label {
            font-weight: 500;
        }
        .table-responsive {
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .table th {
            cursor: pointer;
            user-select: none;
        }
        .table th.sortable:after {
            content: '\f0dc';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 0.5rem;
            color: rgba(255, 255, 255, 0.5);
        }
        .table th.asc:after { content: '\f0d8'; color: white; }
        .table th.desc:after { content: '\f0d7'; color: white; }
        
        /* Ukrywanie kolumn na małych ekranach */
        @media (max-width: 768px) {
            .d-none-sm { display: none; }
        }

        /* Stylowanie wydruku */
        .print-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 100%;
            height: auto;
            overflow: hidden;
            z-index: -1;
        }
        @media print {
            body > *:not(.print-container) { display: none; }
            .print-container { 
                position: static; left: auto; top: auto;
                display: flex; flex-wrap: wrap; align-content: flex-start;
                width: 100%; margin: 0; padding: 0; z-index: auto;
            }
            .label-item {
                display: inline-block; width: 9cm; height: 5cm; border: 1px solid #333;
                margin: 0.5cm; padding: 0.5cm; box-sizing: border-box; text-align: center;
                page-break-inside: avoid; overflow: hidden;
            }
            .label-item .qr-code { width: 3.5cm !important; height: 3.5cm !important; margin: 0 auto; display: block; }
            .label-item h3 { font-size: 14px; font-weight: bold; margin: 5px 0; }
            .label-item p { font-size: 12px; margin: 2px 0; }
        }

        /* Stylowanie modalu skanera */
        .modal { display: none; background-color: rgba(0,0,0,0.7); }
        .modal-content-custom { max-width: 500px; }
        #scanner-container { width: 100%; height: 300px; overflow: hidden; position: relative; }
        #scanner-container video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div class="container container-app">
        <div class="card mb-4">
            <div class="card-header card-header-custom text-center py-3">
                <h1 class="h4 mb-0">Aplikacja Magazynu Produkcyjnego</h1>
            </div>
            <div class="card-body">
                <h2 class="h5 text-indigo mb-4">Dodaj Nowy Element</h2>
                <form id="addItemForm" class="row g-3 p-3 bg-light rounded-3">
                    <div class="col-md-6">
                        <label for="itemId" class="form-label">ID Elementu:</label>
                        <input type="text" id="itemId" name="itemId" class="form-control" readonly required>
                    </div>
                    <div class="col-md-6">
                        <label for="itemName" class="form-label">Nazwa Elementu:</label>
                        <input type="text" id="itemName" name="itemName" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="description" class="form-label">Opis:</label>
                        <input type="text" id="description" name="description" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="category" class="form-label">Kategoria:</label>
                        <input type="text" id="category" name="category" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="quantity" class="form-label">Ilość:</label>
                        <input type="number" id="quantity" name="quantity" class="form-control" required min="0">
                    </div>
                    <div class="col-md-6">
                        <label for="unit" class="form-label">Jednostka:</label>
                        <input type="text" id="unit" name="unit" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="location" class="form-label">Lokalizacja:</label>
                        <input type="text" id="location" name="location" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="supplier" class="form-label">Dostawca:</label>
                        <input type="text" id="supplier" name="supplier" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="reorderLevel" class="form-label">Poziom Zamówienia:</label>
                        <input type="number" id="reorderLevel" name="reorderLevel" min="0" class="form-control">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">Dodaj Element</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header card-header-custom text-center py-3">
                <h2 class="h5 mb-0">Lista Elementów</h2>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <button id="printLabelsBtn" class="btn btn-success d-flex align-items-center">
                        <i class="fa-solid fa-print me-2"></i>Drukuj Etykiety
                    </button>
                    <button id="scanQrBtn" class="btn btn-primary d-flex align-items-center">
                        <i class="fa-solid fa-qrcode me-2"></i>Skanuj Kod QR
                    </button>
                    <button id="exportCsvBtn" class="btn btn-secondary d-flex align-items-center">
                        <i class="fa-solid fa-file-csv me-2"></i>Eksportuj do CSV
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" class="sortable" data-sort="itemId">ID Elementu</th>
                                <th scope="col" class="sortable d-none d-md-table-cell" data-sort="itemName">Nazwa Elementu</th>
                                <th scope="col" class="sortable" data-sort="quantity">Ilość</th>
                                <th scope="col" class="sortable d-none d-md-table-cell" data-sort="location">Lokalizacja</th>
                                <th scope="col">Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                                                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

        <div id="printContainer" class="print-container"></div>

        <div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-content-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scannerModalLabel">Skanowanie Kodu QR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="scanner-container"></div>
                    <div id="scan-result" class="inventory-update border rounded p-3 mt-3 d-none">
                        <h3 id="scanned-item-name" class="h6 fw-bold mb-2">Nazwa przedmiotu</h3>
                        <p id="scanned-item-id" class="small mb-1"></p>
                        <p class="mb-3">Aktualna ilość: <span id="scanned-item-quantity"></span></p>
                        
                        <div class="d-flex align-items-center mb-3">
                            <input type="number" id="quantity-change" class="form-control form-control-sm me-2" min="1" value="1" style="width: 80px;">
                            <button id="add-quantity" class="btn btn-success btn-sm me-2"><i class="fa-solid fa-plus"></i></button>
                            <button id="subtract-quantity" class="btn btn-danger btn-sm"><i class="fa-solid fa-minus"></i></button>
                        </div>
                        <button id="update-inventory" class="btn btn-primary w-100">Aktualizuj stan magazynowy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        const addItemForm = document.getElementById('addItemForm');
        const itemIdInput = document.getElementById('itemId');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const printLabelsBtn = document.getElementById('printLabelsBtn');
        const printContainer = document.getElementById('printContainer');
        const scanQrBtn = document.getElementById('scanQrBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const scannerModal = new bootstrap.Modal(document.getElementById('scannerModal'));
        const scanResult = document.getElementById('scan-result');
        const scannedItemName = document.getElementById('scanned-item-name');
        const scannedItemId = document.getElementById('scanned-item-id');
        const scannedItemQuantity = document.getElementById('scanned-item-quantity');
        const quantityChange = document.getElementById('quantity-change');
        const addQuantityBtn = document.getElementById('add-quantity');
        const subtractQuantityBtn = document.getElementById('subtract-quantity');
        const updateInventoryBtn = document.getElementById('update-inventory');

        const API_URL = 'https://serwer.sebaruman.pl/api/inventory';
        let inventory = [];
        let scannedItem = null;
        let quantityOperation = 'add';
        let html5QrCode = null;
        let sortColumn = 'itemId';
        let sortDirection = 'asc';

        async function generateItemId() {
            const now = new Date();
            const timestamp = now.getTime();
            const randomPart = Math.floor(Math.random() * 1000);
            return `ITEM-${timestamp}-${randomPart}`;
        }

        async function fetchInventory() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Błąd HTTP! Status: ${response.status}`);
                }
                inventory = await response.json();
                sortAndRenderInventory();
            } catch (error) {
                console.error('Błąd podczas pobierania danych z serwera:', error);
            }
        }
        
        function sortAndRenderInventory() {
            inventory.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            renderInventory();
        }

        function renderInventory() {
            inventoryTableBody.innerHTML = '';
            inventory.forEach((item, index) => {
                const row = inventoryTableBody.insertRow();
                row.innerHTML = `
                    <td>${item.itemId}</td>
                    <td class="d-none d-md-table-cell">${item.itemName}</td>
                    <td>${item.quantity} ${item.unit || ''}</td>
                    <td class="d-none d-md-table-cell">${item.location || ''}</td>
                    <td class="text-end">
                        <button onclick="printSingleLabel('${item.itemId}')" class="btn btn-sm btn-success me-1"><i class="fa-solid fa-print"></i></button>
                        <button onclick="showItemDetails('${item.itemId}')" class="btn btn-sm btn-info me-1"><i class="fa-solid fa-circle-info"></i></button>
                        <button onclick="deleteItem('${item.itemId}')" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
            });
        }

        function showItemDetails(itemId) {
            const item = inventory.find(i => i.itemId === itemId);
            if (!item) {
                alert('Nie znaleziono elementu!');
                return;
            }
            
            console.log('Szczegóły elementu:', item);
            
            let details = 'Szczegóły elementu:\n\n';
            for (const [key, value] of Object.entries(item)) {
                details += `${key}: ${value}\n`;
            }
            
            alert(details);
        }

        addItemForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const newItem = {
                itemId: await generateItemId(),
                itemName: document.getElementById('itemName').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                quantity: parseInt(document.getElementById('quantity').value),
                unit: document.getElementById('unit').value,
                location: document.getElementById('location').value,
                supplier: document.getElementById('supplier').value,
                reorderLevel: parseInt(document.getElementById('reorderLevel').value),
                lastUpdated: new Date().toISOString().slice(0, 10)
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newItem)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Błąd HTTP! Status: ${response.status}, Wiadomość: ${errorData.message}`);
                }

                await fetchInventory();
                addItemForm.reset();
                alert('Element dodany pomyślnie!');
                itemIdInput.value = await generateItemId();
            } catch (error) {
                console.error('Błąd podczas dodawania elementu:', error);
                alert(`Nie udało się dodać elementu: ${error.message}`);
            }
        });

        async function deleteItem(itemId) {
            if (confirm(`Czy na pewno chcesz usunąć element o ID: ${itemId}?`)) {
                try {
                    const response = await fetch(`${API_URL}/${itemId}`, { method: 'DELETE' });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Błąd HTTP! Status: ${response.status}, Wiadomość: ${errorData.message}`);
                    }

                    await fetchInventory();
                    alert(`Element ${itemId} usunięty pomyślnie!`);
                } catch (error) {
                    console.error('Błąd podczas usuwania elementu:', error);
                    alert(`Nie udało się usunąć elementu: ${error.message}`);
                }
            }
        }

        async function updateQuantity(itemId, newQuantity) {
            try {
                const item = inventory.find(item => item.itemId === itemId);
                if (!item) {
                    throw new Error('Nie znaleziono produktu o podanym ID');
                }
                
                const response = await fetch(`${API_URL}/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQuantity, lastUpdated: new Date().toISOString().slice(0, 10) })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Odpowiedź serwera:', errorText);
                    throw new Error(`Błąd HTTP! Status: ${response.status}`);
                }
                
                await fetchInventory();
                return true;
            } catch (error) {
                console.error('Błąd podczas aktualizacji ilości:', error);
                alert(`Nie udało się zaktualizować ilości: ${error.message}`);
                return false;
            }
        }

        function printSingleLabel(itemId) {
            const item = inventory.find(i => i.itemId === itemId);
            if (!item) {
                alert('Nie znaleziono elementu o podanym ID!');
                return;
            }
            
            const tempPrintContainer = document.createElement('div');
            
            const labelDiv = createLabelElement(item);
            tempPrintContainer.appendChild(labelDiv);
            
            document.body.appendChild(tempPrintContainer);
            
            const qrCodeDiv = labelDiv.querySelector('.qr-code');
            new QRCode(qrCodeDiv, { text: item.itemId, width: 128, height: 128 });

            setTimeout(() => {
                window.print();
                tempPrintContainer.remove();
            }, 200);
        }
        
        function createLabelElement(item) {
            const labelDiv = document.createElement('div');
            labelDiv.classList.add('label-item');
            
            const qrCodeDiv = document.createElement('div');
            qrCodeDiv.classList.add('qr-code');
            labelDiv.appendChild(qrCodeDiv);
            
            const itemNameElem = document.createElement('h3');
            itemNameElem.textContent = item.itemName;
            labelDiv.appendChild(itemNameElem);
            
            const itemIdElem = document.createElement('p');
            itemIdElem.textContent = `ID: ${item.itemId}`;
            labelDiv.appendChild(itemIdElem);
            
            const quantityElem = document.createElement('p');
            quantityElem.textContent = `Ilość: ${item.quantity} ${item.unit || ''}`;
            labelDiv.appendChild(quantityElem);
            
            const locationElem = document.createElement('p');
            locationElem.textContent = `Lokalizacja: ${item.location || ''}`;
            labelDiv.appendChild(locationElem);
            
            return labelDiv;
        }

        printLabelsBtn.addEventListener('click', function() {
            if (inventory.length === 0) {
                alert('Brak elementów do wydrukowania etykiet.');
                return;
            }
            
            printContainer.innerHTML = '';
            
            let promises = [];
            
            inventory.forEach(item => {
                const labelDiv = createLabelElement(item);
                printContainer.appendChild(labelDiv);
                
                promises.push(new Promise(resolve => {
                    const qrCodeDiv = labelDiv.querySelector('.qr-code');
                    new QRCode(qrCodeDiv, { text: item.itemId, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
                    setTimeout(resolve, 50); 
                }));
            });
            
            Promise.all(promises).then(() => {
                window.print();
            });
        });

        exportCsvBtn.addEventListener('click', () => {
            if (inventory.length === 0) {
                alert('Brak danych do wyeksportowania.');
                return;
            }
            
            const headers = Object.keys(inventory[0]);
            let csvContent = headers.join(',') + '\n';
            
            inventory.forEach(item => {
                const row = headers.map(header => {
                    const value = item[header];
                    return `"${String(value || '').replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += row + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `magazyn-produkcyjny-${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function initQrScanner() {
            if (html5QrCode) return;
            
            html5QrCode = new Html5Qrcode("scanner-container");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
        }
        
        function stopQrScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log('Skaner zatrzymany');
                    html5QrCode = null;
                }).catch(err => {
                    console.error('Błąd podczas zatrzymywania skanera:', err);
                    html5QrCode = null;
                });
            } else {
                html5QrCode = null;
            }
        }

        function onScanSuccess(decodedText) {
            const item = inventory.find(item => item.itemId === decodedText);
            
            if (item) {
                stopQrScanner();
                scannedItem = item;
                
                scannedItemName.textContent = item.itemName;
                scannedItemId.textContent = `ID: ${item.itemId}`;
                scannedItemQuantity.textContent = `${item.quantity} ${item.unit || ''}`;
                
                scanResult.classList.remove('d-none');
            } else {
                alert(`Nie znaleziono produktu o ID: ${decodedText}`);
            }
        }
        
        function onScanFailure(error) {
            console.log('Skanowanie w toku...');
        }

        scanQrBtn.addEventListener('click', function() {
            html5QrCode = null;
            scannerModal.show();
            scanResult.classList.add('d-none');
            
            setTimeout(() => {
                initQrScanner();
            }, 100);
        });

        // Zmiana: Nasłuchujemy na zdarzenie 'hide.bs.modal' z Bootstrapa
        document.getElementById('scannerModal').addEventListener('hide.bs.modal', function() {
            stopQrScanner();
        });
        
        addQuantityBtn.addEventListener('click', function() {
            quantityOperation = 'add';
            addQuantityBtn.classList.add('active');
            subtractQuantityBtn.classList.remove('active');
        });
        
        subtractQuantityBtn.addEventListener('click', function() {
            quantityOperation = 'subtract';
            subtractQuantityBtn.classList.add('active');
            addQuantityBtn.classList.remove('active');
        });
        
        updateInventoryBtn.addEventListener('click', async function() {
            if (!scannedItem) {
                alert('Nie wybrano produktu!');
                return;
            }
            
            const changeValue = parseInt(quantityChange.value);
            if (isNaN(changeValue) || changeValue <= 0) {
                alert('Wprowadź poprawną liczbę sztuk!');
                return;
            }
            
            let newQuantity;
            if (quantityOperation === 'add') {
                newQuantity = scannedItem.quantity + changeValue;
            } else {
                newQuantity = Math.max(0, scannedItem.quantity - changeValue);
            }
            
            const success = await updateQuantity(scannedItem.itemId, newQuantity);
            if (success) {
                alert(`Stan magazynowy produktu "${scannedItem.itemName}" został zaktualizowany.`);
                scannerModal.hide();
                stopQrScanner();
            }
        });
        
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }

                document.querySelectorAll('th.sortable').forEach(h => {
                    h.classList.remove('asc', 'desc');
                });
                header.classList.add(sortDirection);
                
                sortAndRenderInventory();
            });
        });

        async function init() {
            await fetchInventory();
            itemIdInput.value = await generateItemId();
            setInterval(fetchInventory, 10000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>